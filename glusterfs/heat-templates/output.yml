heat_template_version: 2018-03-02
description: Deploying a set of server for a GlusterFS Cluster

parameters:
    image:
        type: string
        label: Image ID or Name
        description: An image to run a server(s) from
        default: CentOS-7

    flavor:
        type: string    
        label: Flavor ID or Name
        description: A flavor for a server(s)
        default: v1.small

    frontend_network:
        type: string
        label: Subnet ID or Name
        description: A public network for connecting clients to a cluster
        default: OSQ-External-Network

    backend_network:
        type: string
        label: Subnet ID or Name
        description: A private network for the cluster's internals
        default: ipsystems-management

    sshkey:
        type: string
        label: SSHPair ID or Name
        description: SSH keypair, those public key will be injected into the cluster nodes
        default: 

    allowed_tcp_ports:
        type: comma_delimited_list
        label: A list of ports
        description: A list of tcp ports which will be accessed via a security group
        default: "22,111,2049,139,445,965,2049,631"

    allowed_udp_ports:
        type: comma_delimited_list
        label: A list of ports
        description: A list of udp ports which will be accessed via a security group    
        default: "111,963"


    volume_size:
        type: number
        label: Disk size
        description: Size of a single volume in Gb
        default: 20

    volume_type:
        type: string
        label: Storage volume type
        description: Type of a volume as defined in OpenStack database
        default: CephStorage




resources:


    tcp_ports:
        type: OS::Neutron::SecurityGroup
        properties:
            rules:
                repeat:
                    for_each:
                        <%port%>: { get_param: allowed_tcp_ports }
                    template:
                        direction: ingress
                        ethertype: IPv4
                        port_range_min: <%port%>
                        port_range_max: <%port%>
                        protocol: tcp
                        remote_ip_prefix: 0.0.0.0/0    
   
    udp_ports:
        type: OS::Neutron::SecurityGroup
        properties:
            rules:
                repeat:
                    for_each:
                        <%port%>: { get_param: allowed_udp_ports }
                    template:
                        direction: ingress
                        ethertype: IPv4
                        port_range_min: <%port%>
                        port_range_max: <%port%>
                        protocol: tcp
                        remote_ip_prefix: 0.0.0.0/0    
    icmp_ports:
        type: OS::Neutron::SecurityGroup
        properties:
            rules:
              - direction: ingress
                ethertype: IPv4
                protocol: icmp
                remote_ip_prefix: 0.0.0.0/0
     

    all_ports:
        type: OS::Neutron::SecurityGroup
        properties: 
            rules:
              - direction: ingress
                ethertype: IPv4
                remote_ip_prefix: 0.0.0.0/0


 
### -------  Server 1


    s1vol1:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s1vol1attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s1vol1 }
            instance_uuid: { get_resource: server1 }

    s1vol2:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s1vol2attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s1vol2 }
            instance_uuid: { get_resource: server1 }

    s1vol3:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s1vol3attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s1vol3 }
            instance_uuid: { get_resource: server1 }

    s1vol4:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s1vol4attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s1vol4 }
            instance_uuid: { get_resource: server1 }


    s1port01:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: frontend_network }
            security_groups:
              - { get_resource: tcp_ports }
              - { get_resource: udp_ports }
              - { get_resource: icmp_ports }

    s1port02:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: backend_network }
            security_groups:
              - { get_resource: all_ports }
  
    server1:
        type: OS::Nova::Server
        properties:
            name:
                str_replace:
                    template: $stackname-node1
                    params:
                        $stackname: { get_param: "OS::stack_name" }
            image: { get_param: image } 
            flavor: { get_param: flavor }
            key_name: { get_param: sshkey }
            # user_data: { get_param: userdata_script }
            user_data:
                str_replace:
                    template: |
                        #!/bin/bash
                        import sys
                        cat << EOF > /tmp/helper.py
                        #!/usr/bin/env python
                        import sys
                        def calcDottedNetmask(mask):
                            bits = 0
                            for i in xrange(32-mask,32):
                                bits |= (1 << i)
                            return "%d.%d.%d.%d" % ((bits & 0xff000000) >> 24, (bits & 0xff0000) >> 16, (bits & 0xff00) >> 8 , (bits & 0xff))
                        print(calcDottedNetmask(int(sys.argv[1].split('/')[1])))
                        EOF
                
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
                        DEVICE=eth0
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port1_ipaddr
                        NETMASK=`python /tmp/helper.py $port1_netmask`
                        GATEWAY=$port1_gateway
                        DNS1=$port1_dns1
                        DNS2=$port1_dns2
                        EOF
    
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth1
                        DEVICE=eth1
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port2_ipaddr
                        NETMASK=`python /tmp/helper.py $port2_netmask`
                        EOF
                        rm -f /tmp/helper.py || true 
                        # sudo yum install -y lvm2
                        # cat << CMDS | sudo bash
                        # pvcreate $dev1 $dev2 $dev3 $dev4 
                        # CMDS
                        cat << DEVS | sudo tee /.devices
                        $dev1
                        $dev2
                        $dev3
                        $dev4 
                        DEVS
                        sudo yum install -y epel-release lvm2
                        sudo yum update -y 
                        touch /.installed
                        sudo reboot
                    params:
                        $port1_ipaddr:  { get_attr: [ s1port01, fixed_ips, 0, ip_address ]}
                        $port1_netmask: { get_attr: [ s1port01, subnets, 0, cidr ]}
                        $port1_gateway: { get_attr: [ s1port01, subnets, 0, gateway_ip ]}
                        $port1_dns1:    { get_attr: [ s1port01, subnets, 0, dns_nameservers, 0 ]}
                        $port1_dns2:    { get_attr: [ s1port01, subnets, 0, dns_nameservers, 1 ]}
                        $port2_ipaddr:  { get_attr: [ s1port02, fixed_ips, 0, ip_address ]}
                        $port2_netmask: { get_attr: [ s1port02, subnets, 0, cidr ]}
                        $dev1: { get_attr: [ s1vol1, attachments_list, 0, device ]}
                        $dev2: { get_attr: [ s1vol2, attachments_list, 0, device ]}
                        $dev3: { get_attr: [ s1vol3, attachments_list, 0, device ]}
                        $dev4: { get_attr: [ s1vol4, attachments_list, 0, device ]}
            networks: [ port: { get_resource: s1port01 }, port: { get_resource: s1port02 }]

 
### -------  Server 2


    s2vol1:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s2vol1attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s2vol1 }
            instance_uuid: { get_resource: server2 }

    s2vol2:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s2vol2attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s2vol2 }
            instance_uuid: { get_resource: server2 }

    s2vol3:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s2vol3attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s2vol3 }
            instance_uuid: { get_resource: server2 }

    s2vol4:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s2vol4attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s2vol4 }
            instance_uuid: { get_resource: server2 }


    s2port01:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: frontend_network }
            security_groups:
              - { get_resource: tcp_ports }
              - { get_resource: udp_ports }
              - { get_resource: icmp_ports }

    s2port02:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: backend_network }
            security_groups:
              - { get_resource: all_ports }
  
    server2:
        type: OS::Nova::Server
        properties:
            name:
                str_replace:
                    template: $stackname-node2
                    params:
                        $stackname: { get_param: "OS::stack_name" }
            image: { get_param: image } 
            flavor: { get_param: flavor }
            key_name: { get_param: sshkey }
            # user_data: { get_param: userdata_script }
            user_data:
                str_replace:
                    template: |
                        #!/bin/bash
                        import sys
                        cat << EOF > /tmp/helper.py
                        #!/usr/bin/env python
                        import sys
                        def calcDottedNetmask(mask):
                            bits = 0
                            for i in xrange(32-mask,32):
                                bits |= (1 << i)
                            return "%d.%d.%d.%d" % ((bits & 0xff000000) >> 24, (bits & 0xff0000) >> 16, (bits & 0xff00) >> 8 , (bits & 0xff))
                        print(calcDottedNetmask(int(sys.argv[1].split('/')[1])))
                        EOF
                
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
                        DEVICE=eth0
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port1_ipaddr
                        NETMASK=`python /tmp/helper.py $port1_netmask`
                        GATEWAY=$port1_gateway
                        DNS1=$port1_dns1
                        DNS2=$port1_dns2
                        EOF
    
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth1
                        DEVICE=eth1
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port2_ipaddr
                        NETMASK=`python /tmp/helper.py $port2_netmask`
                        EOF
                        rm -f /tmp/helper.py || true 
                        # sudo yum install -y lvm2
                        # cat << CMDS | sudo bash
                        # pvcreate $dev1 $dev2 $dev3 $dev4 
                        # CMDS
                        cat << DEVS | sudo tee /.devices
                        $dev1
                        $dev2
                        $dev3
                        $dev4 
                        DEVS
                        sudo yum install -y epel-release lvm2
                        sudo yum update -y 
                        touch /.installed
                        sudo reboot
                    params:
                        $port1_ipaddr:  { get_attr: [ s2port01, fixed_ips, 0, ip_address ]}
                        $port1_netmask: { get_attr: [ s2port01, subnets, 0, cidr ]}
                        $port1_gateway: { get_attr: [ s2port01, subnets, 0, gateway_ip ]}
                        $port1_dns1:    { get_attr: [ s2port01, subnets, 0, dns_nameservers, 0 ]}
                        $port1_dns2:    { get_attr: [ s2port01, subnets, 0, dns_nameservers, 1 ]}
                        $port2_ipaddr:  { get_attr: [ s2port02, fixed_ips, 0, ip_address ]}
                        $port2_netmask: { get_attr: [ s2port02, subnets, 0, cidr ]}
                        $dev1: { get_attr: [ s2vol1, attachments_list, 0, device ]}
                        $dev2: { get_attr: [ s2vol2, attachments_list, 0, device ]}
                        $dev3: { get_attr: [ s2vol3, attachments_list, 0, device ]}
                        $dev4: { get_attr: [ s2vol4, attachments_list, 0, device ]}
            networks: [ port: { get_resource: s2port01 }, port: { get_resource: s2port02 }]

 
### -------  Server 3


    s3vol1:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s3vol1attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s3vol1 }
            instance_uuid: { get_resource: server3 }

    s3vol2:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s3vol2attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s3vol2 }
            instance_uuid: { get_resource: server3 }

    s3vol3:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s3vol3attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s3vol3 }
            instance_uuid: { get_resource: server3 }

    s3vol4:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s3vol4attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s3vol4 }
            instance_uuid: { get_resource: server3 }


    s3port01:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: frontend_network }
            security_groups:
              - { get_resource: tcp_ports }
              - { get_resource: udp_ports }
              - { get_resource: icmp_ports }

    s3port02:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: backend_network }
            security_groups:
              - { get_resource: all_ports }
  
    server3:
        type: OS::Nova::Server
        properties:
            name:
                str_replace:
                    template: $stackname-node3
                    params:
                        $stackname: { get_param: "OS::stack_name" }
            image: { get_param: image } 
            flavor: { get_param: flavor }
            key_name: { get_param: sshkey }
            # user_data: { get_param: userdata_script }
            user_data:
                str_replace:
                    template: |
                        #!/bin/bash
                        import sys
                        cat << EOF > /tmp/helper.py
                        #!/usr/bin/env python
                        import sys
                        def calcDottedNetmask(mask):
                            bits = 0
                            for i in xrange(32-mask,32):
                                bits |= (1 << i)
                            return "%d.%d.%d.%d" % ((bits & 0xff000000) >> 24, (bits & 0xff0000) >> 16, (bits & 0xff00) >> 8 , (bits & 0xff))
                        print(calcDottedNetmask(int(sys.argv[1].split('/')[1])))
                        EOF
                
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
                        DEVICE=eth0
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port1_ipaddr
                        NETMASK=`python /tmp/helper.py $port1_netmask`
                        GATEWAY=$port1_gateway
                        DNS1=$port1_dns1
                        DNS2=$port1_dns2
                        EOF
    
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth1
                        DEVICE=eth1
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port2_ipaddr
                        NETMASK=`python /tmp/helper.py $port2_netmask`
                        EOF
                        rm -f /tmp/helper.py || true 
                        # sudo yum install -y lvm2
                        # cat << CMDS | sudo bash
                        # pvcreate $dev1 $dev2 $dev3 $dev4 
                        # CMDS
                        cat << DEVS | sudo tee /.devices
                        $dev1
                        $dev2
                        $dev3
                        $dev4 
                        DEVS
                        sudo yum install -y epel-release lvm2
                        sudo yum update -y 
                        touch /.installed
                        sudo reboot
                    params:
                        $port1_ipaddr:  { get_attr: [ s3port01, fixed_ips, 0, ip_address ]}
                        $port1_netmask: { get_attr: [ s3port01, subnets, 0, cidr ]}
                        $port1_gateway: { get_attr: [ s3port01, subnets, 0, gateway_ip ]}
                        $port1_dns1:    { get_attr: [ s3port01, subnets, 0, dns_nameservers, 0 ]}
                        $port1_dns2:    { get_attr: [ s3port01, subnets, 0, dns_nameservers, 1 ]}
                        $port2_ipaddr:  { get_attr: [ s3port02, fixed_ips, 0, ip_address ]}
                        $port2_netmask: { get_attr: [ s3port02, subnets, 0, cidr ]}
                        $dev1: { get_attr: [ s3vol1, attachments_list, 0, device ]}
                        $dev2: { get_attr: [ s3vol2, attachments_list, 0, device ]}
                        $dev3: { get_attr: [ s3vol3, attachments_list, 0, device ]}
                        $dev4: { get_attr: [ s3vol4, attachments_list, 0, device ]}
            networks: [ port: { get_resource: s3port01 }, port: { get_resource: s3port02 }]

 
### -------  Server 4


    s4vol1:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s4vol1attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s4vol1 }
            instance_uuid: { get_resource: server4 }

    s4vol2:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s4vol2attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s4vol2 }
            instance_uuid: { get_resource: server4 }

    s4vol3:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s4vol3attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s4vol3 }
            instance_uuid: { get_resource: server4 }

    s4vol4:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s4vol4attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s4vol4 }
            instance_uuid: { get_resource: server4 }


    s4port01:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: frontend_network }
            security_groups:
              - { get_resource: tcp_ports }
              - { get_resource: udp_ports }
              - { get_resource: icmp_ports }

    s4port02:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: backend_network }
            security_groups:
              - { get_resource: all_ports }
  
    server4:
        type: OS::Nova::Server
        properties:
            name:
                str_replace:
                    template: $stackname-node4
                    params:
                        $stackname: { get_param: "OS::stack_name" }
            image: { get_param: image } 
            flavor: { get_param: flavor }
            key_name: { get_param: sshkey }
            # user_data: { get_param: userdata_script }
            user_data:
                str_replace:
                    template: |
                        #!/bin/bash
                        import sys
                        cat << EOF > /tmp/helper.py
                        #!/usr/bin/env python
                        import sys
                        def calcDottedNetmask(mask):
                            bits = 0
                            for i in xrange(32-mask,32):
                                bits |= (1 << i)
                            return "%d.%d.%d.%d" % ((bits & 0xff000000) >> 24, (bits & 0xff0000) >> 16, (bits & 0xff00) >> 8 , (bits & 0xff))
                        print(calcDottedNetmask(int(sys.argv[1].split('/')[1])))
                        EOF
                
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
                        DEVICE=eth0
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port1_ipaddr
                        NETMASK=`python /tmp/helper.py $port1_netmask`
                        GATEWAY=$port1_gateway
                        DNS1=$port1_dns1
                        DNS2=$port1_dns2
                        EOF
    
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth1
                        DEVICE=eth1
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port2_ipaddr
                        NETMASK=`python /tmp/helper.py $port2_netmask`
                        EOF
                        rm -f /tmp/helper.py || true 
                        # sudo yum install -y lvm2
                        # cat << CMDS | sudo bash
                        # pvcreate $dev1 $dev2 $dev3 $dev4 
                        # CMDS
                        cat << DEVS | sudo tee /.devices
                        $dev1
                        $dev2
                        $dev3
                        $dev4 
                        DEVS
                        sudo yum install -y epel-release lvm2
                        sudo yum update -y 
                        touch /.installed
                        sudo reboot
                    params:
                        $port1_ipaddr:  { get_attr: [ s4port01, fixed_ips, 0, ip_address ]}
                        $port1_netmask: { get_attr: [ s4port01, subnets, 0, cidr ]}
                        $port1_gateway: { get_attr: [ s4port01, subnets, 0, gateway_ip ]}
                        $port1_dns1:    { get_attr: [ s4port01, subnets, 0, dns_nameservers, 0 ]}
                        $port1_dns2:    { get_attr: [ s4port01, subnets, 0, dns_nameservers, 1 ]}
                        $port2_ipaddr:  { get_attr: [ s4port02, fixed_ips, 0, ip_address ]}
                        $port2_netmask: { get_attr: [ s4port02, subnets, 0, cidr ]}
                        $dev1: { get_attr: [ s4vol1, attachments_list, 0, device ]}
                        $dev2: { get_attr: [ s4vol2, attachments_list, 0, device ]}
                        $dev3: { get_attr: [ s4vol3, attachments_list, 0, device ]}
                        $dev4: { get_attr: [ s4vol4, attachments_list, 0, device ]}
            networks: [ port: { get_resource: s4port01 }, port: { get_resource: s4port02 }]

 
### -------  Server 5


    s5vol1:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s5vol1attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s5vol1 }
            instance_uuid: { get_resource: server5 }

    s5vol2:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s5vol2attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s5vol2 }
            instance_uuid: { get_resource: server5 }

    s5vol3:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s5vol3attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s5vol3 }
            instance_uuid: { get_resource: server5 }

    s5vol4:
        type: OS::Cinder::Volume
        properties:
            size: { get_param: volume_size }
            volume_type: { get_param: volume_type }

    s5vol4attach:
        type: OS::Cinder::VolumeAttachment
        properties:
            volume_id: { get_resource: s5vol4 }
            instance_uuid: { get_resource: server5 }


    s5port01:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: frontend_network }
            security_groups:
              - { get_resource: tcp_ports }
              - { get_resource: udp_ports }
              - { get_resource: icmp_ports }

    s5port02:
        type: OS::Neutron::Port
        properties:
            network_id: { get_param: backend_network }
            security_groups:
              - { get_resource: all_ports }
  
    server5:
        type: OS::Nova::Server
        properties:
            name:
                str_replace:
                    template: $stackname-node5
                    params:
                        $stackname: { get_param: "OS::stack_name" }
            image: { get_param: image } 
            flavor: { get_param: flavor }
            key_name: { get_param: sshkey }
            # user_data: { get_param: userdata_script }
            user_data:
                str_replace:
                    template: |
                        #!/bin/bash
                        import sys
                        cat << EOF > /tmp/helper.py
                        #!/usr/bin/env python
                        import sys
                        def calcDottedNetmask(mask):
                            bits = 0
                            for i in xrange(32-mask,32):
                                bits |= (1 << i)
                            return "%d.%d.%d.%d" % ((bits & 0xff000000) >> 24, (bits & 0xff0000) >> 16, (bits & 0xff00) >> 8 , (bits & 0xff))
                        print(calcDottedNetmask(int(sys.argv[1].split('/')[1])))
                        EOF
                
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth0
                        DEVICE=eth0
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port1_ipaddr
                        NETMASK=`python /tmp/helper.py $port1_netmask`
                        GATEWAY=$port1_gateway
                        DNS1=$port1_dns1
                        DNS2=$port1_dns2
                        EOF
    
                        cat << EOF | sudo tee /etc/sysconfig/network-scripts/ifcfg-eth1
                        DEVICE=eth1
                        BOOTPROTO=static
                        ONBOOT=yes
                        NM_CONTROLLED=no
                        IPADDR=$port2_ipaddr
                        NETMASK=`python /tmp/helper.py $port2_netmask`
                        EOF
                        rm -f /tmp/helper.py || true 
                        # sudo yum install -y lvm2
                        # cat << CMDS | sudo bash
                        # pvcreate $dev1 $dev2 $dev3 $dev4 
                        # CMDS
                        cat << DEVS | sudo tee /.devices
                        $dev1
                        $dev2
                        $dev3
                        $dev4 
                        DEVS
                        sudo yum install -y epel-release lvm2
                        sudo yum update -y 
                        touch /.installed
                        sudo reboot
                    params:
                        $port1_ipaddr:  { get_attr: [ s5port01, fixed_ips, 0, ip_address ]}
                        $port1_netmask: { get_attr: [ s5port01, subnets, 0, cidr ]}
                        $port1_gateway: { get_attr: [ s5port01, subnets, 0, gateway_ip ]}
                        $port1_dns1:    { get_attr: [ s5port01, subnets, 0, dns_nameservers, 0 ]}
                        $port1_dns2:    { get_attr: [ s5port01, subnets, 0, dns_nameservers, 1 ]}
                        $port2_ipaddr:  { get_attr: [ s5port02, fixed_ips, 0, ip_address ]}
                        $port2_netmask: { get_attr: [ s5port02, subnets, 0, cidr ]}
                        $dev1: { get_attr: [ s5vol1, attachments_list, 0, device ]}
                        $dev2: { get_attr: [ s5vol2, attachments_list, 0, device ]}
                        $dev3: { get_attr: [ s5vol3, attachments_list, 0, device ]}
                        $dev4: { get_attr: [ s5vol4, attachments_list, 0, device ]}
            networks: [ port: { get_resource: s5port01 }, port: { get_resource: s5port02 }]

 


outputs:

    srv1port1_ip: { value: { get_attr: [ s1port01, fixed_ips, 0, ip_address ]}}
    srv1port2_ip: { value: { get_attr: [ s1port02, fixed_ips, 0, ip_address ]}}
    srv1devs: 
        value:
            list_join:
                - ' '
                - { get_attr: [ s1vol1, attachments_list, 0, device ]}
                - { get_attr: [ s1vol2, attachments_list, 0, device ]}
                - { get_attr: [ s1vol3, attachments_list, 0, device ]}
                - { get_attr: [ s1vol4, attachments_list, 0, device ]}

    srv2port1_ip: { value: { get_attr: [ s2port01, fixed_ips, 0, ip_address ]}}
    srv2port2_ip: { value: { get_attr: [ s2port02, fixed_ips, 0, ip_address ]}}
    srv2devs: 
        value:
            list_join:
                - ' '
                - { get_attr: [ s2vol1, attachments_list, 0, device ]}
                - { get_attr: [ s2vol2, attachments_list, 0, device ]}
                - { get_attr: [ s2vol3, attachments_list, 0, device ]}
                - { get_attr: [ s2vol4, attachments_list, 0, device ]}

    srv3port1_ip: { value: { get_attr: [ s3port01, fixed_ips, 0, ip_address ]}}
    srv3port2_ip: { value: { get_attr: [ s3port02, fixed_ips, 0, ip_address ]}}
    srv3devs: 
        value:
            list_join:
                - ' '
                - { get_attr: [ s3vol1, attachments_list, 0, device ]}
                - { get_attr: [ s3vol2, attachments_list, 0, device ]}
                - { get_attr: [ s3vol3, attachments_list, 0, device ]}
                - { get_attr: [ s3vol4, attachments_list, 0, device ]}

    srv4port1_ip: { value: { get_attr: [ s4port01, fixed_ips, 0, ip_address ]}}
    srv4port2_ip: { value: { get_attr: [ s4port02, fixed_ips, 0, ip_address ]}}
    srv4devs: 
        value:
            list_join:
                - ' '
                - { get_attr: [ s4vol1, attachments_list, 0, device ]}
                - { get_attr: [ s4vol2, attachments_list, 0, device ]}
                - { get_attr: [ s4vol3, attachments_list, 0, device ]}
                - { get_attr: [ s4vol4, attachments_list, 0, device ]}

    srv5port1_ip: { value: { get_attr: [ s5port01, fixed_ips, 0, ip_address ]}}
    srv5port2_ip: { value: { get_attr: [ s5port02, fixed_ips, 0, ip_address ]}}
    srv5devs: 
        value:
            list_join:
                - ' '
                - { get_attr: [ s5vol1, attachments_list, 0, device ]}
                - { get_attr: [ s5vol2, attachments_list, 0, device ]}
                - { get_attr: [ s5vol3, attachments_list, 0, device ]}
                - { get_attr: [ s5vol4, attachments_list, 0, device ]}

 